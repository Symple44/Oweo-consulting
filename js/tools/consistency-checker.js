// ========================================
// js/tools/consistency-checker.js - Outil de v√©rification de coh√©rence
// ========================================

class ConsistencyChecker {
    constructor() {
        this.issues = [];
        this.warnings = [];
        this.infos = [];
    }
    
    /**
     * V√©rifier la coh√©rence de toutes les configurations
     */
    checkAll() {
        console.log('üîç D√©marrage de la v√©rification de coh√©rence...');
        
        this.issues = [];
        this.warnings = [];
        this.infos = [];
        
        // V√©rifications principales
        this.checkCompanyInfo();
        this.checkAppConfig();
        this.checkCrossReferences();
        this.checkDOMElements();
        this.checkExternalServices();
        
        // G√©n√©rer le rapport
        this.generateReport();
        
        return {
            success: this.issues.length === 0,
            issues: this.issues,
            warnings: this.warnings,
            infos: this.infos
        };
    }
    
    /**
     * V√©rifier CompanyInfo
     */
    checkCompanyInfo() {
        if (!window.CompanyInfo) {
            this.addIssue('CompanyInfo non charg√©');
            return;
        }
        
        const info = window.CompanyInfo;
        
        // V√©rifications email
        if (!info.contact?.email) {
            this.addIssue('Email de contact manquant');
        } else if (!this.isValidEmail(info.contact.email)) {
            this.addIssue(`Email invalide: ${info.contact.email}`);
        } else if (!info.contact.email.includes('oweo')) {
            this.addWarning(`Email ne contient pas 'oweo': ${info.contact.email}`);
        }
        
        // V√©rifications t√©l√©phone
        if (!info.contact?.phone) {
            this.addIssue('T√©l√©phone de contact manquant');
        } else if (!info.contact.phone.startsWith('+33')) {
            this.addWarning(`T√©l√©phone ne commence pas par +33: ${info.contact.phone}`);
        }
        
        // V√©rifications URLs
        if (info.urls?.website && !info.urls.website.startsWith('https://')) {
            this.addIssue(`URL website doit √™tre HTTPS: ${info.urls.website}`);
        }
        
        if (info.urls?.calendly && !info.urls.calendly.includes('calendly.com')) {
            this.addIssue(`URL Calendly invalide: ${info.urls.calendly}`);
        }
        
        this.addInfo('CompanyInfo v√©rifi√©');
    }
    
    /**
     * V√©rifier AppConfig
     */
    checkAppConfig() {
        if (!window.AppConfig) {
            this.addIssue('AppConfig non charg√©');
            return;
        }
        
        const config = window.AppConfig;
        
        // V√©rifier que les getters fonctionnent
        try {
            const contact = config.contact;
            if (!contact?.email) {
                this.addIssue('AppConfig.contact.email non accessible');
            }
        } catch (error) {
            this.addIssue(`Erreur AppConfig.contact: ${error.message}`);
        }
        
        try {
            const calendlyUrl = config.calendlyUrl;
            if (!calendlyUrl) {
                this.addIssue('AppConfig.calendlyUrl non accessible');
            }
        } catch (error) {
            this.addIssue(`Erreur AppConfig.calendlyUrl: ${error.message}`);
        }
        
        this.addInfo('AppConfig v√©rifi√©');
    }
    
    /**
     * V√©rifier les r√©f√©rences crois√©es
     */
    checkCrossReferences() {
        if (!window.CompanyInfo || !window.AppConfig) {
            this.addWarning('Impossible de v√©rifier les r√©f√©rences crois√©es');
            return;
        }
        
        const companyEmail = window.CompanyInfo.contact?.email;
        const appConfigEmail = window.AppConfig.contact?.email;
        
        if (companyEmail && appConfigEmail && companyEmail !== appConfigEmail) {
            this.addIssue(`Incoh√©rence email: CompanyInfo(${companyEmail}) vs AppConfig(${appConfigEmail})`);
        }
        
        const companyPhone = window.CompanyInfo.contact?.phone;
        const appConfigPhone = window.AppConfig.contact?.phone;
        
        if (companyPhone && appConfigPhone && companyPhone !== appConfigPhone) {
            this.addIssue(`Incoh√©rence t√©l√©phone: CompanyInfo(${companyPhone}) vs AppConfig(${appConfigPhone})`);
        }
        
        const companyCalendly = window.CompanyInfo.urls?.calendly;
        const appConfigCalendly = window.AppConfig.calendlyUrl;
        
        if (companyCalendly && appConfigCalendly && companyCalendly !== appConfigCalendly) {
            this.addIssue(`Incoh√©rence Calendly: CompanyInfo(${companyCalendly}) vs AppConfig(${appConfigCalendly})`);
        }
        
        this.addInfo('R√©f√©rences crois√©es v√©rifi√©es');
    }
    
    /**
     * V√©rifier les √©l√©ments DOM
     */
    checkDOMElements() {
        // V√©rifier les liens de contact dans le DOM
        const emailLinks = document.querySelectorAll('a[href^="mailto:"]');
        const phoneLinks = document.querySelectorAll('a[href^="tel:"]');
        
        const uniqueEmails = new Set();
        const uniquePhones = new Set();
        
        emailLinks.forEach(link => {
            const email = link.href.replace('mailto:', '').split('?')[0];
            uniqueEmails.add(email);
        });
        
        phoneLinks.forEach(link => {
            const phone = link.href.replace('tel:', '');
            uniquePhones.add(phone);
        });
        
        if (uniqueEmails.size > 1) {
            this.addWarning(`Emails multiples dans le DOM: ${Array.from(uniqueEmails).join(', ')}`);
        }
        
        if (uniquePhones.size > 1) {
            this.addWarning(`T√©l√©phones multiples dans le DOM: ${Array.from(uniquePhones).join(', ')}`);
        }
        
        // V√©rifier la coh√©rence avec la config
        const configEmail = window.CompanyInfo?.contact?.email;
        if (configEmail && uniqueEmails.size > 0 && !uniqueEmails.has(configEmail)) {
            this.addIssue(`Email config (${configEmail}) absent du DOM`);
        }
        
        this.addInfo(`DOM v√©rifi√©: ${emailLinks.length} liens email, ${phoneLinks.length} liens t√©l√©phone`);
    }
    
    /**
     * V√©rifier les services externes
     */
    checkExternalServices() {
        // V√©rifier Calendly
        if (typeof window.Calendly !== 'undefined') {
            this.addInfo('Widget Calendly charg√©');
        } else {
            this.addWarning('Widget Calendly non charg√©');
        }
        
        // V√©rifier FontAwesome
        const faElement = document.querySelector('.fas, .fab, .far');
        if (faElement) {
            this.addInfo('FontAwesome d√©tect√©');
        } else {
            this.addWarning('FontAwesome non d√©tect√©');
        }
    }
    
    /**
     * Utilitaires
     */
    isValidEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }
    
    addIssue(message) {
        this.issues.push({ type: 'ERROR', message, timestamp: new Date() });
    }
    
    addWarning(message) {
        this.warnings.push({ type: 'WARNING', message, timestamp: new Date() });
    }
    
    addInfo(message) {
        this.infos.push({ type: 'INFO', message, timestamp: new Date() });
    }
    
    /**
     * G√©n√©rer le rapport
     */
    generateReport() {
        console.log('\nüìä RAPPORT DE COH√âRENCE');
        console.log('========================');
        
        if (this.issues.length === 0) {
            console.log('‚úÖ Aucun probl√®me d√©tect√©');
        } else {
            console.log(`‚ùå ${this.issues.length} probl√®me(s) d√©tect√©(s):`);
            this.issues.forEach(issue => {
                console.log(`  ‚ùå ${issue.message}`);
            });
        }
        
        if (this.warnings.length > 0) {
            console.log(`\n‚ö†Ô∏è ${this.warnings.length} avertissement(s):`);
            this.warnings.forEach(warning => {
                console.log(`  ‚ö†Ô∏è ${warning.message}`);
            });
        }
        
        if (this.infos.length > 0) {
            console.log(`\n‚ÑπÔ∏è Informations (${this.infos.length}):`);
            this.infos.forEach(info => {
                console.log(`  ‚ÑπÔ∏è ${info.message}`);
            });
        }
        
        console.log('\n========================');
        
        const score = this.calculateScore();
        console.log(`üìà Score de coh√©rence: ${score}%`);
        
        if (score < 80) {
            console.log('üî¥ Score faible - corrections recommand√©es');
        } else if (score < 95) {
            console.log('üü° Score correct - am√©liorations possibles');
        } else {
            console.log('üü¢ Excellente coh√©rence');
        }
    }
    
    calculateScore() {
        const totalChecks = this.issues.length + this.warnings.length + this.infos.length;
        if (totalChecks === 0) return 100;
        
        const errorWeight = 10;
        const warningWeight = 3;
        
        const penalty = (this.issues.length * errorWeight) + (this.warnings.length * warningWeight);
        const maxPenalty = totalChecks * errorWeight;
        
        const score = Math.max(0, Math.round(((maxPenalty - penalty) / maxPenalty) * 100));
        return score;
    }
    
    /**
     * Mode d'√©coute continue
     */
    startMonitoring(interval = 10000) {
        console.log(`üîÑ D√©marrage de la surveillance (${interval/1000}s)`);
        
        setInterval(() => {
            const result = this.checkAll();
            if (!result.success) {
                console.warn('üö® Nouvelles incoh√©rences d√©tect√©es');
            }
        }, interval);
    }
    
    /**
     * Export du rapport
     */
    exportReport() {
        const report = {
            timestamp: new Date().toISOString(),
            score: this.calculateScore(),
            summary: {
                issues: this.issues.length,
                warnings: this.warnings.length,
                infos: this.infos.length
            },
            details: {
                issues: this.issues,
                warnings: this.warnings,
                infos: this.infos
            }
        };
        
        return JSON.stringify(report, null, 2);
    }
}

// Cr√©er une instance globale
window.ConsistencyChecker = ConsistencyChecker;

// Auto-lancement en mode d√©veloppement
if (window.location.hostname === 'localhost') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const checker = new ConsistencyChecker();
            const result = checker.checkAll();
            
            // Exposer pour tests manuels
            window.checkConsistency = () => checker.checkAll();
            window.startMonitoring = () => checker.startMonitoring();
            
            console.log('üí° Utilisez checkConsistency() pour relancer une v√©rification');
            console.log('üí° Utilisez startMonitoring() pour surveiller en continu');
        }, 2000);
    });
}